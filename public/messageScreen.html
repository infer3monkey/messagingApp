<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <script src="/socket.io/socket.io.js"></script>
        <title>Fireplace</title>
        <!-- css was primarily made by ai with some modifications -->
        <style>
            body {
                height: 100vh;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                background: linear-gradient(0deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .message-card {
                background: black;
                border-radius: 18px;
                box-shadow: 0 8px 32px 0 rgba(200, 0, 0, 0.9);
                padding: 40px 32px;
                min-width: 320px;
                max-width: 100%;
                display: flex;
                flex-direction: column;
                gap: 18px;
                width: 1000px;
            }

            .message-card h1 {
                margin: 0 0 20px 0;
                font-size: 2.1em;
                font-weight: 700;
                color: rgb(200, 100, 0);
                text-align: center;
                letter-spacing: 1px;
            }

            #messages {
                background: rgba(46, 45, 45, 1);
                border: 1px solid rgb(200, 100, 0);
                border-radius: 8px;
                min-height: 500px;
                max-height: 600px;
                overflow-y: auto;
                padding: 15px;
                font-size: 1em;
                color: #333;
            }

            form {
                display: flex;
                gap: 12px;
            }

            form input[type="text"] {
                flex-grow: 1;
                padding: 10px 12px;
                border-radius: 6px;
                border: 1px solid rgb(200, 100, 0);;
                font-size: 1em;
                transition: border-color 0.2s, box-shadow 0.2s;
                outline: none;
                background: rgba(46, 45, 45, 1);
                color: rgb(200, 100, 0);
            }

            form input[type="text"]:focus {
                border-color: rgb(200, 100, 0);
                box-shadow: 0 0 16px rgb(200, 100, 0);;
            }

            form button[type="submit"] {
                padding: 10px 28px;
                background: linear-gradient(0deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                color: black;
                border: 3px solid rgba(200, 0, 0, 0.9);
                border-radius: 6px;
                font-size: 1.05em;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s, transform 0.2s;
                box-shadow: 0 3px 10px rgb(57 173 219 / 8%);
            }

            form button[type="submit"]:hover {
                background: linear-gradient(90deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                transform: translateY(-2px) scale(1.04);
            }

            /* My Personal Css */
            .usernameElement {
                color: rgb(200, 100, 0);
                display: inline;
            }

            p.messageElement {
                color: rgb(200, 100, 0);
                display: block;
                margin-top: 20px;
                margin-bottom: 20px;
                font-size: 16px;
                padding: 8px 12px;
                line-height: 1.4;
                border: 1px solid rgb(200, 100, 0);
                border-radius: 4px;
                box-sizing: border-box;
                width: 100%;
            }

            input.messageElement {
                color: rgb(200, 0, 0);
                display: block;
                margin-top: 20px;
                margin-bottom: 20px;
                font-size: 16px;
                padding: 8px 12px;
                line-height: 1.4;
                background: rgba(46, 45, 45, 1);
                border: 1px solid rgb(200, 0, 0);
                border-radius: 4px;
                box-sizing: border-box;
                width: 100%;
            }

            .buttonElement {
                min-height: 20px;
                min-width: 50px;
                background: linear-gradient(0deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                color: black;
                border: 3px solid rgba(200, 0, 0, 0.9);
                border-radius: 6px;
                font-size: 1.05em;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s, transform 0.2s;
                box-shadow: 0 3px 10px rgb(57 173 219 / 8%);
                margin-left: 10px;
            }

            .buttonElement:hover {
                background: linear-gradient(90deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                transform: translateY(-2px) scale(1.04);
            }

            .logoutButton {
                background: linear-gradient(0deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                color: black;
                border: 3px solid black;
                border-radius: 6px;
                font-size: 1.05em;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s, transform 0.2s;
                box-shadow: 0 3px 10px rgb(57 173 219 / 8%);
                position: fixed;
                top: 0;
                right: 0;
                margin: 16px;
                padding: 10px 28px;
            }

            .logoutButton:hover {
                background: linear-gradient(90deg, rgb(252, 132, 3) , rgb(200, 0, 0));
                transform: translateY(-2px) scale(1.04);
            }

        </style>
    </head>
    <body>

        <button class="logoutButton" onclick="
            logout()
        ">Logout</button>

        <div class="message-card">
        <h1>Global Chat</h1>

        <div id="messages">
            Where the Messages Go
        </div>

        <form id="messageForm">
            <input type="text" id="newMessage" placeholder="New Message Here..." required />
            <button type="submit">Send Message</button>
        </form>
        </div>
        
        <script>
            // Should send person back to the normal website if they don't have a valid token
            const token = localStorage.getItem('token') || null

            // Socket Stuff
            const socket = io();

            socket.on('connect', () => {
                console.log('Connected with ID:', socket.id);
            });

            // Sends a message to server
            //socket.emit('message', 'Hello from client!');

            function logout() {
                localStorage.setItem('token', null)
                console.log("logged out")
                window.location.href = '/'
            }

            function sendMessage(newMessageText) {
                fetch('/messages/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        'text': newMessageText
                    })
                })
                .then(response => response.json())
                .then(data => {
                    socket.emit('loadMessages', 'sentMessage')
                    loadAllMessages()
                })
                .catch(error => {
                    console.error('Error Sending Message:', error)
                })
            }
            
            function deleteMessage(messageId, messageDiv) {
                fetch(`/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Maybe check if it was successful?
                    socket.emit('loadMessages', 'deletedMessage')
                    messageDiv.remove()
                })
            }

            function editMessage(messageId, messageDiv) {
                // Check if the Message is currently being edited or if the edit is being submitted
                let messageElement = document.getElementById(`message-${messageId}`)
                if(messageElement.tagName === "P") {
                    // Turn the Element into an input
                    const newMessageElement = document.createElement('input')
                    const messageContent = messageElement.textContent
                    newMessageElement.value = messageContent
                    newMessageElement.className = "messageElement"
                    newMessageElement.id = `message-${messageId}`
                    messageElement.replaceWith(newMessageElement)
                } else if (messageElement.tagName === "INPUT") {
                    // Turn the input element into a paragraph
                    const newMessageElement = document.createElement('p')
                    const messageContent = messageElement.value
                    newMessageElement.textContent = messageContent
                    newMessageElement.className = "messageElement"
                    newMessageElement.id = `message-${messageId}`

                    // Send the New Text to the server
                    fetch(`/messages/${messageId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'text': messageContent
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        //messageDiv.remove()
                        socket.emit('loadMessages', 'editedMessage')
                        messageElement.replaceWith(newMessageElement)
                    })

                    //messageElement.replaceWith(newMessageElement)
                }
            }

            document.getElementById('messageForm').addEventListener('submit', function(e) {
                e.preventDefault() // Prevents Page Reload
                const message = document.getElementById('newMessage').value.trim() //.trim() removes whitespace from beggining and end
                if (message) {
                    sendMessage(message)
                    document.getElementById('newMessage').value = ""
                }
            })

            function checkIfValidToken() {
                fetch('/messages/verifyToken/', {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.status >= 200 && response.status < 300) {
                        console.log("Token is Valid")
                        
                    } else {
                        console.log("Token Invalid")
                        window.location.href = '/'
                    }
                })
                .catch(error => {
                    // Not a valid token don't send them anywhere
                    console.error('Error Validating Token:', error)
                    window.location.href = '/'
                })
            }

            function loadAllMessages() {
                let allMessages = ''
                fetch('/messages/all/', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const messageContainer = document.getElementById('messages')
                    messageContainer.innerHTML = ''
                    for (i=0; i < data.messages.length; i++){

                        const newMessageDiv = document.createElement('div')

                        const messageElement = document.createElement('p')
                        const usernameElement = document.createElement('p')

                        const editButton = document.createElement('button')
                        const deleteButton = document.createElement('button')

                        const messageId = data.messages[i].id

                        usernameElement.textContent = data.messages[i].username + ":"
                        usernameElement.className = "usernameElement"

                        messageElement.textContent = data.messages[i].text
                        messageElement.className = "messageElement"
                        // Each Message Element has a unique message id which I will use with the document.getElementById
                        messageElement.id = `message-${messageId}`

                        editButton.onclick = function() {
                            editMessage(messageId, newMessageDiv)
                        }

                        deleteButton.onclick = function() {
                            deleteMessage(messageId, newMessageDiv)
                        }

                        editButton.className = "buttonElement"
                        editButton.textContent = "Edit"
                        deleteButton.className = "buttonElement"
                        deleteButton.textContent = "Delete"
                        // I can set the onclick property for these buttons, I can pass in these elements through parameters

                        newMessageDiv.appendChild(usernameElement)
                        if (data.requestUserId == data.messages[i].user_id) {
                            newMessageDiv.appendChild(editButton)
                            newMessageDiv.appendChild(deleteButton)
                        }
                        newMessageDiv.appendChild(messageElement)

                        messageContainer.appendChild(newMessageDiv)

                        //messageContainer.removeChild()

                        //allMessages += data[i].username + ": " + data[i].text + "<br>"
                    }
                    //document.getElementById("messages").innerHTML = allMessages
                })
                .catch(error => {
                    console.error('Error Fetching All Messages:', error)
                })
                
            }

            checkIfValidToken()
            loadAllMessages()

            // This will be run when we want to load all messages cause someone changed something
            socket.on('loadMessages', (msg) => {
                //console.log('Received:', msg);
                loadAllMessages();
            });

        </script>
    </body>

</html>